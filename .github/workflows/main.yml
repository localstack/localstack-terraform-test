on:
  schedule:
    - cron: '0 19 * * 6'
  workflow_dispatch:
    inputs:
      services:
        default: 'ls-community'
        type: string
        description: name of the service to execute tests for (e.g. "ls-community", "ls-pro", "ls-all", "s3,iam,ec2")
      localstack-image:
        required: false
        type: string
        default: 'localstack/localstack:latest'
        description: localstack docker image name to test against

name: Terraform Tests
jobs:

  prepare_list:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - id: set-matrix
        run: echo "matrix=$(python -m terraform_pytest.get-services ${{ github.event.inputs.services || 'ls-community' }})" >> $GITHUB_OUTPUT
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

  test_service:
    needs: prepare_list
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.prepare_list.outputs.matrix) }}
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v3
      with:
        submodules: 'true'

    - uses: actions/setup-go@v3
      with:
        go-version: '1.18.x'
        cache: true
        cache-dependency-path: terraform-provider-aws/go.sum

    - name: Set up Python 3.10.5
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.5'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Patch Terraform Provider
      run: |
        cd terraform-provider-aws && go mod vendor
        cd ../
        python -m terraform_pytest.main patch

    - name: Build ${{ matrix.service }} Binary
      run: |
        python -m terraform_pytest.main build -s ${{ matrix.service }}
        ls -la terraform-provider-aws/test-bin

    - name: Run ${{ matrix.service }} Tests
      env:
        PYTEST_PARALLEL_CONFIG: "${{ matrix.service == 'ec2' && '-n 2' || '' }}"
      run: |
        python -m pytest $PYTEST_PARALLEL_CONFIG --junitxml=target/reports/pytest.xml terraform-provider-aws/internal/service/${{ matrix.service }} -s -v --ls-start --ls-image ${{ github.event.inputs.localstack-image || 'localstack/localstack:latest' }}

    - name: Run ${{ matrix.service }} Tests
      if: ${{ matrix.service == 'ec2' }}
      run: |
        IMAGE_TAG=${{ github.event.inputs.localstack-image || 'localstack/localstack:latest' }} docker-compose up -d
        sleep 20
        python -m pytest --junitxml=target/reports/pytest.xml terraform-provider-aws/internal/service/${{ matrix.service }} -s -v -n 2


    - name: Publish ${{ matrix.service }} Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        junit_files: target/reports/*.xml
        check_name: ${{ matrix.service }} Terraform Test Results
