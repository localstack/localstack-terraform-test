version: 2.1

orbs:
  localstack: localstack/platform@dev:alpha

jobs:
  build:
    # machine:
    #   image: ubuntu-2004:202101-01
    executor: localstack/default
    environment:
      DOWNLOAD_TEST_BIN: 1
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run:
          name: "Installing prerequisites"
          command: |
            sudo apt-get update
            sudo apt install -y python3.8-dev libsasl2-dev

      # download/install and cache aws.test and localstack pip
      - restore_cache:
          keys:
            - localstack-cache

      - run: bin/install-aws-test
      - run:
          name: "Installing LocalStack"
          command: |
            cd localstack
            virtualenv --python=`which python3.8` .venv
            make install
            cd ..
      - run:
          name: "Preparing test environment"
          command: |
            virtualenv --python=`which python3.8` .venv
            source .venv/bin/activate
            pip install -r requirements.txt
            pip install -r localstack/requirements.txt
            pip install -e ./localstack/
            pip install -e ./moto/
            python -m tests.generator

      - save_cache:
          key: localstack-cache
          paths:
            - /home/circleci/.cache/localstack/
            - /home/circleci/.cache/pip/
      - localstack/startup

      # main test suite
      - run:
          name: "Running test suite"
          command: |
            source .venv/bin/activate
            python -m pytest tests/ -k "$(cat localstack-tests.incl.txt | xargs | sed 's/ / or /g')"
          # command: bin/run-tests -t localstack-tests.incl.txt

      # save build reports as artifacts
      - run:
          name: "Creating reports"
          when: always
          command: |
            source .venv/bin/activate
            bin/create-report
            bin/create-report-html

      - store_test_results:
          path: target/reports-xunit
      - store_artifacts:
          path: target/logs
      - store_artifacts:
          path: target/reports-html


workflows:
  main:
    jobs:
      - build
