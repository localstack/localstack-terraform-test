version: 2.1

orbs:
  go: circleci/go@1.7.1
#   localstack: localstack/platform@dev:alpha

jobs:
  build:
    machine:
      image: ubuntu-2004:202101-01
    resource_class: medium
    steps:
      - checkout
      - go/install:
            version: '1.19'
      - run: git submodule update --init --recursive
      - run:
          name: "Installing prerequisites"
          command: |
            sudo apt-get update
            sudo apt install -y libsasl2-dev
            pip3 install -r requirements.txt

      - run:
          name: "Configuring repos for tests"
          command: |
            cd terraform-provider-aws && go mod vendor
            cd ../
            python3 main.py patch
#            cd terraform-provider-aws && go test -c ./internal/service/s3 -o ./test-bin/s3.test
#            python3 main.py build -s s3

      - run:
          name: "Run test suite"
          no_output_timeout: 30m
          command: |
            export PYTHONUNBUFFERED=1
            pytest terraform-provider-aws/internal/service/s3 -s -v --ls-start

workflows:
  main:
    when:
      or:
        - equal: [ build, << pipeline.git.branch >> ]
        - equal: [ build-new, << pipeline.git.branch >> ]
        - equal: [ pytest-plugin, << pipeline.git.branch >> ]
    jobs:
      - build