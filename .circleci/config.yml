version: 2.1

orbs:
  localstack: localstack/platform@dev:alpha

jobs:
  build:
    executor: localstack/default
    steps:
      - checkout

      - run: git submodule update --init --recursive
      - run:
          name: "Installing prerequisites"
          command: |
            sudo apt-get update
            sudo apt install -y python3.8 libsasl2-dev
            pip install -r requirements.txt

      - run:
          name: "Install go mod dependancies"
          command: |
            python main.py patch
            cd terraform-provider-aws
            go mod vendor

      - run:
          name: "Run test suite"
          command: |
            pytest terraform-provider-aws/internal/service/s3/bucket_object_test.go -k ignore -s -v --ls-start

workflows:
  main:
    when:
      or:
        - equal: [ build, << pipeline.git.branch >> ]
        - equal: [ build-new, << pipeline.git.branch >> ]
        - equal: [ pytest-plugin, << pipeline.git.branch >> ]
    jobs:
      - build
